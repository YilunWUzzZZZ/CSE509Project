#include "helpers.h"

#define LOG_FILE "safex_debug.log"
int find_in(char *my_str, char *string_list[], size_t num_strings)
{
    for ( int i = 0; i < num_strings; i++ )
        if (strcmp(my_str, string_list[i]) == 0 )
            return 1;
FILE* log_fd = fopen(LOG_FILE, "ab+");
fprintf(log_fd, " %s: not Opening file %s\n", __FUNCTION__,my_str);
fclose(log_fd);
    return 0;
}

int safetoread_path(char *pathname)
{
  char *file_list[] = {"./driver_return2_helper","./driver_return2_injectedcode","./driver_canary_bruteforce","./driver_return2_helper2", "./vuln","./driver_auth_db", "/etc/ld.so.preload", "/lib/x86_64-linux-gnu/libc.so.6" ,"/etc/ld.so.cache" };
FILE* log_fd = fopen(LOG_FILE, "ab+");\
fprintf(log_fd, " %s: Opening file %s\n", __FUNCTION__,pathname);
fclose(log_fd);
  
if (find_in(pathname, file_list,9))
  {
		return 1;
  }
	
	return 0;
}

int strLen(char *s)
{
    char  *p = s;
    
    while(*p != '\0')
    {
        p++ ; 
    }
    p = p - s;
    return p;
}

int search_buffer(char *buffer, size_t buffer_len, char *str, size_t str_len)
{  
    int searchlen = buffer_len - str_len + 1;
    
    for ( ; searchlen-- > 0; buffer++)
        if (!memcmp(buffer, str, str_len))
            return 1;
            
    return 0;
}


int safetoread_buffer(char *buffer)
{
    char str1[] = "%";
    char str2[] = "$";
      
    size_t buffer_len = strLen(buffer);
    printf("Lentgh: %d",buffer_len);
    size_t str_len = sizeof(str1)-1;
    int ret1 = search_buffer(buffer, buffer_len, str1, str_len);
    int ret2 = search_buffer(buffer, buffer_len, str2, str_len);
    
    if (ret1 && ret2)
        return 1;

    return 0;
}
